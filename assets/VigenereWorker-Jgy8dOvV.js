(function(){"use strict";const k={E:.1202,T:.091,A:.0812,O:.0768,I:.0731,N:.0695,S:.0628,R:.0602,H:.0592,D:.0432,L:.0398,U:.0288,C:.0271,M:.0261,F:.023,Y:.0211,W:.0209,G:.0203,P:.0182,B:.0149,V:.0111,K:.0069,X:.0017,Q:.0011,J:.001,Z:7e-4};function U(l){const n=l.toUpperCase(),t={};let r=0;for(let s=0;s<n.length;s++){const e=n[s];/[A-Z]/.test(e)&&(t[e]=(t[e]||0)+1,r++)}for(const s in t)t[s]/=r;return t}function F(l){let n=0;for(let t=0;t<26;t++){const r=String.fromCharCode(65+t),s=l[r]||0,e=k[r]||0;e>0&&(n+=Math.pow(s-e,2)/e)}return n}function S(l,n){if(!n)return l;const t=n.toUpperCase();let r="",s=0;for(let e=0;e<l.length;e++){const c=l[e];if(c.match(/[a-z]/i)){const a=c===c.toUpperCase(),i=c.toUpperCase().charCodeAt(0)-65,C=t[s%t.length].charCodeAt(0)-65;let h=(i-C+26)%26,y=String.fromCharCode(h+65);a||(y=y.toLowerCase()),r+=y,s++}else r+=c}return r}function b(l,n){const t=l.toLowerCase().split(/[^a-z]+/).filter(a=>a.length>0);let r=0,s=0;for(const a of t)if(a.length>=2){const i=n[a];i&&(r++,s+=i)}const e=t.length>0?r/t.length*100:0,c=t.length>0?s/t.length:0;return{count:r,total:t.length,percentage:e,weightedScore:c}}function K(l,n,t,r,s){let e=l,c=S(n,e),a=b(c,t),i=a.percentage,o=0,C=!1,h=0;const y=[];for(;i<r&&o<s||o<s&&o-h<10;){o++,o%5===0&&y.push({iteration:o,score:i,key:e});let w=!1;const M=o-h>5;for(let p=0;p<e.length;p++){const u=Array.from({length:26},(d,f)=>f);for(let d=u.length-1;d>0;d--){const f=Math.floor(Math.random()*(d+1));[u[d],u[f]]=[u[f],u[d]]}for(const d of u){if(e.charCodeAt(p)-65===d)continue;const f=e.substring(0,p)+String.fromCharCode(65+d)+e.substring(p+1),g=S(n,f),m=b(g,t);if(m.percentage>i){e=f,i=m.percentage,c=g,a=m,w=!0,C=!0,h=o;break}}if(w)break;if(M&&p<e.length-1){const d=e.substring(0,p)+e.charAt(p+1)+e.charAt(p)+e.substring(p+2),f=S(n,d),g=b(f,t);if(g.percentage>i){e=d,i=g.percentage,c=f,a=g,w=!0,C=!0,h=o;break}}}if(!w){const p=Math.min(Math.floor((o-h)/3)+1,Math.floor(e.length/2));let u=e;for(let g=0;g<p;g++){const m=Math.floor(Math.random()*u.length),I=Math.floor(Math.random()*26);u=u.substring(0,m)+String.fromCharCode(65+I)+u.substring(m+1)}const d=S(n,u),f=b(d,t);f.percentage>i&&(e=u,i=f.percentage,c=d,a=f,C=!0,h=o)}if(i>=r)break}return{finalKey:e,improved:C,iterations:o,wordStats:a,decrypted:c,progressUpdates:y}}function R(l,n,t,r,s){return l.map(c=>{const a=S(n,c),i=b(a,t);if(i.percentage>=r)return{key:c,decrypted:a,wordStats:i,refined:!1,iterations:0};const o=K(c,n,t,r,s);return{key:o.finalKey,decrypted:o.decrypted,wordStats:o.wordStats,refined:o.improved,iterations:o.iterations,progressUpdates:o.progressUpdates}})}function A(l,n,t){return l.map(r=>{const s=S(n,r),e=b(s,t),c=U(s),a=F(c);return{key:r,decrypted:s,wordStats:e,chiSquared:a}})}self.onmessage=function(l){const{type:n,data:t}=l.data;switch(n){case"processCandidates":const{candidates:r,ciphertext:s,dictionary:e,targetPercentage:c,maxIterations:a}=t,i=R(r,s,e,c,a);self.postMessage({type:"candidatesResult",results:i});break;case"processBruteForce":const{keys:o,bruteForceText:C,bruteForceDict:h}=t,y=A(o,C,h);self.postMessage({type:"bruteForceResult",results:y});break;case"refineKey":const{key:w,refineText:M,refineDict:p,refineTarget:u,refineMaxIter:d}=t,f=K(w,M,p,u,d);self.postMessage({type:"refineResult",result:f});break}}})();
